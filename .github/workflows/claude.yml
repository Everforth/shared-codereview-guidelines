name: Claude Code

on:
  workflow_call:
    secrets:
      ANTHROPIC_API_KEY:
        required: true

jobs:
  claude:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 95  # 30分 × 最大3回 + 余裕
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Clone shared codereview guidelines
        run: |
          git clone --depth 1 https://github.com/Everforth/shared-codereview-guidelines.git
          echo "Guidelines repository cloned successfully"

      # Claude Code 実行 (最大3回リトライ)
      - name: Run Claude Code (attempt 1)
        id: claude1
        continue-on-error: true
        timeout-minutes: 30
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          additional_permissions: |
            actions: read
          allowed_tools: "Bash(git log:*),Bash(npm install),Bash(npm run *)"
          custom_instructions: |
            【最初に必ず実施】依頼内容のタイプを判定してください：

            A. 設計相談・方針検討
            - 設計パターンの比較、アーキテクチャ選択の相談、実装方針への意見・フィードバックを求める依頼、「〜が気になる」「〜は問題か」などの質問など
            → 結論を出さず、客観的にメリット・デメリットを明示する。判断するための比較材料を提供する。判断・推奨・良し悪しの提示は禁止。

            B. コードレビュー（上記に該当しない場合）
            - 無言での呼び出し、「レビューしてください」など一般的なレビュー依頼
            → 技術スタックに応じたガイドラインをReadツールで必ず読み込んでから進む（スキップ禁止）
              - フロントエンド: shared-codereview-guidelines/docs/frontend-guidelines.md をReadツールで読む
              - バックエンド: shared-codereview-guidelines/docs/backend-guidelines.md をReadツールで読む
              - ガイドライン内のSTEP手順に従い、各層のガイドラインもReadツールで読むこと

            【コードレビュー時の観点】
            - 考慮不足や潜在的な問題
            - バグやエラーの可能性
            - セキュリティ上の懸念
            - パフォーマンス上の問題
            - 明らかに改善できる部分

            コードレビューを行う際は、問題がある部分のみを簡潔に指摘し、建設的な改善提案を行ってください。
            良い点の言及・総評は不要です。
            PR の説明文 や リンクされた issue にも目を通し、背景や目的を理解した上でレビューを行ってください。
            意図が不明な場合は質問してください。

            【コード状態の確認（必須）】
            - レビュー開始時に `git log --oneline` を実行し、コミット履歴を把握すること。途中で修正・リバートされた変更を認識し、レビュー対象は最終的なコードの状態とする。
            - <comments> 内のユーザーの指摘や前回レビュー結果は、過去のコード状態に対するものである可能性がある。レビュー指摘として採用する前に、必ず対象ファイルを Read して現在のコードにその問題が実際に存在するか確認すること。現在のコードに存在しない問題は指摘しない。
            - <comments> でユーザーが「対応不要」「意図的」等と判断した項目は尊重する。

            ultrathink してください。
            常に日本語で返信してください。
          max_turns: "100"

      - name: Run Claude Code (attempt 2)
        id: claude2
        if: steps.claude1.outcome == 'failure'
        continue-on-error: true
        timeout-minutes: 30
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          additional_permissions: |
            actions: read
          allowed_tools: "Bash(git log:*),Bash(npm install),Bash(npm run *)"
          custom_instructions: |
            【最初に必ず実施】依頼内容のタイプを判定してください：

            A. 設計相談・方針検討
            - 設計パターンの比較、アーキテクチャ選択の相談、実装方針への意見・フィードバックを求める依頼、「〜が気になる」「〜は問題か」などの質問など
            → 結論を出さず、客観的にメリット・デメリットを明示する。判断するための比較材料を提供する。判断・推奨・良し悪しの提示は禁止。

            B. コードレビュー（上記に該当しない場合）
            - 無言での呼び出し、「レビューしてください」など一般的なレビュー依頼
            → 技術スタックに応じたガイドラインをReadツールで必ず読み込んでから進む（スキップ禁止）
              - フロントエンド: shared-codereview-guidelines/docs/frontend-guidelines.md をReadツールで読む
              - バックエンド: shared-codereview-guidelines/docs/backend-guidelines.md をReadツールで読む
              - ガイドライン内のSTEP手順に従い、各層のガイドラインもReadツールで読むこと

            【コードレビュー時の観点】
            - 考慮不足や潜在的な問題
            - バグやエラーの可能性
            - セキュリティ上の懸念
            - パフォーマンス上の問題
            - 明らかに改善できる部分

            コードレビューを行う際は、問題がある部分のみを簡潔に指摘し、建設的な改善提案を行ってください。
            良い点の言及・総評は不要です。
            PR の説明文 や リンクされた issue にも目を通し、背景や目的を理解した上でレビューを行ってください。
            意図が不明な場合は質問してください。

            【コード状態の確認（必須）】
            - レビュー開始時に `git log --oneline` を実行し、コミット履歴を把握すること。途中で修正・リバートされた変更を認識し、レビュー対象は最終的なコードの状態とする。
            - <comments> 内のユーザーの指摘や前回レビュー結果は、過去のコード状態に対するものである可能性がある。レビュー指摘として採用する前に、必ず対象ファイルを Read して現在のコードにその問題が実際に存在するか確認すること。現在のコードに存在しない問題は指摘しない。
            - <comments> でユーザーが「対応不要」「意図的」等と判断した項目は尊重する。

            ultrathink してください。
            常に日本語で返信してください。
          max_turns: "100"

      - name: Run Claude Code (attempt 3)
        id: claude3
        if: steps.claude2.outcome == 'failure'
        timeout-minutes: 30
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          additional_permissions: |
            actions: read
          allowed_tools: "Bash(git log:*),Bash(npm install),Bash(npm run *)"
          custom_instructions: |
            【最初に必ず実施】依頼内容のタイプを判定してください：

            A. 設計相談・方針検討
            - 設計パターンの比較、アーキテクチャ選択の相談、実装方針への意見・フィードバックを求める依頼、「〜が気になる」「〜は問題か」などの質問など
            → 結論を出さず、客観的にメリット・デメリットを明示する。判断するための比較材料を提供する。判断・推奨・良し悪しの提示は禁止。

            B. コードレビュー（上記に該当しない場合）
            - 無言での呼び出し、「レビューしてください」など一般的なレビュー依頼
            → 技術スタックに応じたガイドラインをReadツールで必ず読み込んでから進む（スキップ禁止）
              - フロントエンド: shared-codereview-guidelines/docs/frontend-guidelines.md をReadツールで読む
              - バックエンド: shared-codereview-guidelines/docs/backend-guidelines.md をReadツールで読む
              - ガイドライン内のSTEP手順に従い、各層のガイドラインもReadツールで読むこと

            【コードレビュー時の観点】
            - 考慮不足や潜在的な問題
            - バグやエラーの可能性
            - セキュリティ上の懸念
            - パフォーマンス上の問題
            - 明らかに改善できる部分

            コードレビューを行う際は、問題がある部分のみを簡潔に指摘し、建設的な改善提案を行ってください。
            良い点の言及・総評は不要です。
            PR の説明文 や リンクされた issue にも目を通し、背景や目的を理解した上でレビューを行ってください。
            意図が不明な場合は質問してください。

            【コード状態の確認（必須）】
            - レビュー開始時に `git log --oneline` を実行し、コミット履歴を把握すること。途中で修正・リバートされた変更を認識し、レビュー対象は最終的なコードの状態とする。
            - <comments> 内のユーザーの指摘や前回レビュー結果は、過去のコード状態に対するものである可能性がある。レビュー指摘として採用する前に、必ず対象ファイルを Read して現在のコードにその問題が実際に存在するか確認すること。現在のコードに存在しない問題は指摘しない。
            - <comments> でユーザーが「対応不要」「意図的」等と判断した項目は尊重する。

            ultrathink してください。
            常に日本語で返信してください。
          max_turns: "100"

      # 処理完了通知
      - name: Notify completion
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            let caller = '';
            if (context.eventName === 'issue_comment' || context.eventName === 'pull_request_review_comment') {
              caller = context.payload.comment?.user?.login;
            } else if (context.eventName === 'pull_request_review') {
              caller = context.payload.review?.user?.login;
            } else if (context.eventName === 'issues') {
              caller = context.payload.sender?.login || context.payload.issue?.user?.login;
            }
            if (!caller) return;

            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            if (!issueNumber) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `@${caller} 完了しました`
            });

      # ラベル追加（Claude正常終了時、PR Titleに"CI Test"が含まれない場合）
      - name: Add EF-guideline-called label
        if: steps.claude1.outcome == 'success' || steps.claude2.outcome == 'success' || steps.claude3.outcome == 'success'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            if (!prNumber) return;

            // PR Titleに"CI Test"が含まれる場合はスキップ
            const prTitle = context.payload.pull_request?.title || context.payload.issue?.title || '';
            if (prTitle.includes('CI Test')) {
              console.log(`PR title contains 'CI Test', skipping label`);
              return;
            }

            const labelName = 'EF-guideline-called';
            const labelColor = '0E8A16';

            // ラベルが存在しなければ作成
            try {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
                color: labelColor,
                description: 'Claude Code review was executed on this PR'
              });
              console.log(`Label '${labelName}' created`);
            } catch (error) {
              if (error.status === 422) {
                console.log(`Label '${labelName}' already exists, skipping creation`);
              } else {
                throw error;
              }
            }

            // PRにラベルを追加
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [labelName]
            });
            console.log(`Label '${labelName}' added to PR #${prNumber}`);
